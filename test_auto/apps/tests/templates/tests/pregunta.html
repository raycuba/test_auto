{% extends "base/base.html" %}
{% load static %}
{% block title %}Preguntas - Auto Escuela{% endblock %}

{% block content %}
<style>
    .respuesta-btn {
        color: #000 !important;
        display: block;
        margin: 10px 0;
        font-size: 1.2rem;
    }
    .correcta { color: white !important; background-color: #009222ff !important; }
    .incorrecta { color: white !important; background-color: #a3000eff !important; }
</style>

<div class="container">

    <div class="row">
        <div class="col-md-8">
        </div>
        <div class="col-md-2 text-md-end">
            <a href="{% url 'tests:list' %}" class="btn btn-outline-secondary">Volver a Tests</a>
        </div>
        <div class="col-md-2 text-md-end">
            <a href="{% url 'tests:clean_respuestas' test=test %}" class="btn btn-outline-secondary">Limpiar Respuestas</a>
        </div>
    </div>

    <div class="row">
        <h2 class="mb-4">Test {{ test }} - Pregunta {{ indice|add:1 }} de {{ total }}</h2>
    </div>

    <div class="row">
        <div class="col-md-8">
            <h4>{{ pregunta.pregunta }}</h4>

            <div id="respuestas">
                {% for clave, texto in pregunta.respuestas.items %}
                    <button class="btn btn-outline-secondary respuesta-btn text-start" data-clave="{{ clave }}">{{ texto }}</button>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-4 text-md-end">
            {% if pregunta.imagen %}
            <img src="{% static 'tests/' %}{{ test }}/{{ pregunta.imagen }}" class="img-fluid my-3" alt="Imagen relacionada">
            {% endif %}
        </div>
    </div>

    <div class="d-flex justify-content-between mt-4">
        {% if numeroPreguntaAnterior != None %}
            <a href="{% url 'tests:pregunta_view' test=test numero=numeroPreguntaAnterior %}" class="btn btn-secondary">Anterior</a>
        {% else %}
            <span></span>
        {% endif %}
        {% if numeroPreguntaSiguiente != None %}
            <a href="{% url 'tests:pregunta_view' test=test numero=numeroPreguntaSiguiente %}" class="btn btn-primary">Próxima</a>
        {% elif completado %}
            <a href="{% url 'tests:resultado_view' test=test %}" class="btn btn-success">Resultados</a>
        {% else %}
            <a href="{% url 'tests:resultado_view' test=test %}" class="btn btn-success d-none">Resultados</a>
        {% endif %}
    </div>
</div>

<script>
    const botones = document.querySelectorAll('.respuesta-btn');
    const correcta = "{{ pregunta.respuestaCorrecta }}";
    const test = "{{ test }}";
    const pregunta = "{{ numero }}";
    const preselected = "{{ preselected|default:'0' }}";

    botones.forEach(btn => {
        btn.addEventListener('click', () => {
            const seleccionada = btn.getAttribute('data-clave');
            botones.forEach(b => b.disabled = true);

            if (seleccionada === correcta) {
                btn.classList.add('correcta');
            } else {
                btn.classList.add('incorrecta');
                botones.forEach(b => {
                    if (b.getAttribute('data-clave') === correcta) {
                        b.classList.add('correcta');
                    }
                });
            }

            // Enviar datos al backend
            fetch("{% url 'tests:registrar_respuesta' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: new URLSearchParams({
                    test: test,
                    pregunta: pregunta,
                    seleccionada: seleccionada
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Respuesta registrada:", data);
                if (data.completado) {
                    const resultadoBtn = document.querySelector('a.btn.btn-success.d-none');
                    resultadoBtn.classList.remove('d-none');
                }
            });
        });

        // Activar automáticamente si coincide con preselected
        if (btn.getAttribute('data-clave') === preselected) {
            btn.click();
        }
    });
</script>
{% endblock %}